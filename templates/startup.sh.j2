#!/bin/bash

SQUASH_TM_HOME="{{ install_dir }}"

# Spring Boot datasource configuration (SquashTM 11.x uses Spring Boot variables)
export SPRING_DATASOURCE_URL="jdbc:mariadb://localhost:3306/{{ db_name }}?useUnicode=true&characterEncoding=UTF-8"
export SPRING_DATASOURCE_USERNAME="{{ db_user }}"
export SPRING_DATASOURCE_PASSWORD="{{ db_password }}"

# JOOQ SQL dialect (required for database query generation)
export SPRING_JOOQ_SQL_DIALECT="MARIADB"

# Default variables
JAR_NAME="${SQUASH_TM_HOME}/bundles/squash-tm.war"
TMP_DIR="${SQUASH_TM_HOME}/tmp"
CONF_DIR="${SQUASH_TM_HOME}/conf"
LOG_DIR="${SQUASH_TM_HOME}/logs"

# Create directories if needed
mkdir -p "${TMP_DIR}"
mkdir -p "${LOG_DIR}"

# Java args
JAVA_ARGS="-Xms512m -Xmx2048m"

ARGS="${JAVA_ARGS} -Duser.language=en -Djava.io.tmpdir=${TMP_DIR} -Dlogging.dir=${LOG_DIR} -jar ${JAR_NAME} --spring.config.additional-location=file:${CONF_DIR}/ --spring.config.name=application,squash.tm.cfg --logging.config=${CONF_DIR}/log4j2.xml"

# Clean temp files
rm -rf ${TMP_DIR}/*

# Start SquashTM
exec java ${ARGS}
